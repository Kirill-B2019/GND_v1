# Консенсус в блокчейне ГАНИМЕД

## Обзор

Блокчейн ГАНИМЕД поддерживает два алгоритма консенсуса:
- Proof of Stake (PoS)
- Proof of Authority (PoA)

Переключение между алгоритмами возможно через конфигурацию или API.

## Proof of Stake (PoS)

### Принцип работы
- Валидаторы делают стейк токенов
- Вероятность создания блока зависит от размера стейка
- Награда за создание блока
- Штрафы за злонамеренное поведение

### Параметры
```go
type PoSConfig struct {
    MinStakeAmount  *big.Int
    BlockTime       int64
    EpochLength     int64
    RewardAmount    *big.Int
    SlashingPenalty *big.Int
    MaxValidators   int
}
```

### Процесс валидации
1. Выбор валидатора
   - Проверка минимального стейка
   - Расчет вероятности
   - Выбор следующего валидатора

2. Создание блока
   - Сбор транзакций
   - Формирование блока
   - Подпись блока
   - Отправка в сеть

3. Верификация блока
   - Проверка подписи
   - Валидация транзакций
   - Обновление состояния
   - Распределение наград

### Награды и штрафы
- Награда за блок: 1 GND
- Награда за верификацию: 0.1 GND
- Штраф за двойную подпись: 10% стейка
- Штраф за неактивность: 1% стейка
- Штраф за атаку на сеть: 50% стейка

## Proof of Authority (PoA)

### Принцип работы
- Использование авторизованных валидаторов
- Ротация валидаторов
- Управление доступом
- Мониторинг активности

### Параметры
```go
type PoAConfig struct {
    Validators      []common.Address
    BlockTime       int64
    RotationInterval int64
    MaxValidators   int
    MinSignatures   int
}
```

### Процесс валидации
1. Выбор валидатора
   - Проверка авторизации
   - Определение очереди
   - Выбор следующего валидатора

2. Создание блока
   - Сбор транзакций
   - Формирование блока
   - Подпись блока
   - Отправка в сеть

3. Верификация блока
   - Проверка подписи
   - Валидация транзакций
   - Обновление состояния
   - Ротация валидаторов

### Управление валидаторами
- Добавление валидатора
  - Проверка репутации
  - Голосование существующих валидаторов
  - Обновление списка

- Удаление валидатора
  - Нарушение правил
  - Неактивность
  - Понижение репутации

## Переключение консенсуса

### Через конфигурацию
```yaml
consensus:
  type: pos  # или poa
  min_stake: 1000000
  block_time: 3
  epoch_length: 100
  validators:
    - "GND..."
    - "GND..."
```

### Через API
```http
POST /consensus/switch
Content-Type: application/json

{
    "type": "pos",
    "params": {
        "minStake": "1000000",
        "blockTime": 3,
        "epochLength": 100
    }
}
```

## Безопасность

### Защита от атак
- Двойная подпись
- Неактивность
- Атака на сеть
- Манипуляция временем

### Аудит
- Мониторинг активности
- Логирование событий
- Анализ угроз
- Реагирование на инциденты

### Восстановление
- Резервное копирование
- Откат состояния
- Обновление валидаторов
- Восстановление стейков

## Мониторинг

### Метрики
- Активность валидаторов
- Размер стейков
- Время создания блоков
- Распределение наград

### Алерты
- Неактивность валидатора
- Подозрительная активность
- Нарушение правил
- Сбои в работе

## Разработка

### Тестирование
- Unit тесты
- Интеграционные тесты
- Нагрузочное тестирование
- Тесты безопасности

### Документация
- API документация
- Руководства
- Примеры кода
- Схемы и диаграммы

## Примеры

### JavaScript
```javascript
const consensus = new GND.Consensus({
    type: 'pos',
    minStake: '1000000',
    blockTime: 3,
    epochLength: 100
});

// Получение валидаторов
const validators = await consensus.getValidators();

// Получение стейка
const stake = await consensus.getStake('GND...');

// Создание блока
const block = await consensus.createBlock();

// Верификация блока
const result = await consensus.verifyBlock(block);
```

### Python
```python
from gnd import Consensus

consensus = Consensus(
    type='pos',
    min_stake='1000000',
    block_time=3,
    epoch_length=100
)

# Получение валидаторов
validators = consensus.get_validators()

# Получение стейка
stake = consensus.get_stake('GND...')

# Создание блока
block = consensus.create_block()

# Верификация блока
result = consensus.verify_block(block)
```

### Go
```go
import "github.com/gnd/consensus"

config := consensus.Config{
    Type:        "pos",
    MinStake:    big.NewInt(1000000),
    BlockTime:   3,
    EpochLength: 100,
}

c := consensus.New(config)

// Получение валидаторов
validators, err := c.GetValidators()

// Получение стейка
stake, err := c.GetStake("GND...")

// Создание блока
block, err := c.CreateBlock()

// Верификация блока
result, err := c.VerifyBlock(block)
```

## Оптимизация

### Производительность
- Параллельная обработка
- Кэширование состояний
- Оптимизация памяти
- Управление ресурсами

### Масштабируемость
- Шардирование
- Репликация
- Балансировка нагрузки
- Распределение данных

## Обновления

### Версионирование
- Семантическое версионирование
- Обратная совместимость
- Миграции данных
- Обновление контрактов

### Миграции
- Планирование обновлений
- Тестирование изменений
- Резервное копирование
- Откат изменений

## Интеграция

### SDK
- JavaScript/TypeScript
- Python
- Go
- Java

### Инструменты
- CLI
- GUI
- Мониторинг
- Аналитика

## Безопасность

### Аудит
- Код
- Контракты
- Конфигурация
- Доступ

### Мониторинг
- Активность
- Аномалии
- Угрозы
- Инциденты

### Реагирование
- Обнаружение
- Анализ
- Устранение
- Профилактика