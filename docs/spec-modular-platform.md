# ТЗ: Модульная платформа и работа с подсетями

Итоговое техническое задание по применимости платформы ГАНИМЕД, работе с подсетями и механизму модульной конструкции для снижения необходимости хардфорков.

---

## 1. Цели

- Обеспечить применимость платформы в режиме нескольких подсетей и взаимодействие между ними (мосты).
- Ввести модульную конструкцию: консенсус и правила выбора — из конфига; идентификация сети — в API и конфиге.

---

## 2. Реализовано (фаза 1)

### 2.1. Идентификация сети

- **config/config.json**
  - `chain_id` (number) — идентификатор сети для мостов и мультичейн-клиентов.
  - `subnet_id` (string, опционально) — идентификатор подсети.

- **API GET /api/v1/health**
  - В ответе возвращаются: `status`, `version`, `timestamp`, `network_id`, `chain_id`, `subnet_id` (если задан).
  - Клиенты и мосты могут однозначно определять сеть по ответу health.

### 2.2. Правила выбора консенсуса из конфига

- **config/consensus.json**
  - Поле `selection_rules` — массив правил выбора консенсуса по адресу получателя транзакции:
    - `address_prefix` — префикс адреса (например `"GNDct"`) → консенсус `"poa"`.
    - `default: true` — правило по умолчанию → консенсус `"pos"`.

- **Поведение**
  - При старте ноды вызывается `consensus.LoadSelectionRules("config/consensus.json")`.
  - Если файл или `selection_rules` отсутствуют — используется встроенная логика (GNDct → PoA, иначе PoS).
  - Добавление или смена правил не требует перекомпиляции (только правка конфига и перезапуск).

Пример `config/consensus.json`:

```json
{
  "consensus": [ ... ],
  "selection_rules": [
    { "address_prefix": "GNDct", "consensus": "poa" },
    { "default": true, "consensus": "pos" }
  ]
}
```

---

## 3. Формат событий для мостов и подсетей

Единый формат событий моста (для оффчейн-интеграций и подсетей) — см. `integration/bridges.go`:

- **BridgeEvent**
  - `ID` — уникальный идентификатор события.
  - `FromChain` / `ToChain` — идентификаторы сетей (рекомендуется использовать `chain_id` в виде строки или число).
  - `TokenAddress`, `ToAddress`, `Amount`, `Type`, `Timestamp`, `Status`, `TxHash`, `Extra`.

Рекомендация: в событиях и в API моста использовать `chain_id` (и при необходимости `subnet_id`) из конфига ноды, чтобы однозначно идентифицировать источник и назначение.

---

## 4. Дальнейшие фазы (ТЗ)

- **Фаза 2:** Реестр стандартов токенов за интерфейсом; запись событий Transfer/Approval в БД или очередь.
- **Фаза 3:** Реестр мостовых контрактов по парам (chain_id, token); доработка FederatedBridge с учётом chain_id.
- **Фаза 4:** Trustless-мост (верификация заголовков/событий другой сети).

---

## 5. Связанные документы

- [architecture.md](architecture.md) — архитектура платформы.
- [services.md](services.md) — перечень сервисов.
- [integration/bridges.go](../integration/bridges.go) — интерфейс моста и FederatedBridge.
