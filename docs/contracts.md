# Смарт-контракты и токены в блокчейне «ГАНИМЕД»

## Общие положения

Блокчейн «ГАНИМЕД» поддерживает полноценную работу со смарт-контрактами на языке Solidity, а также внедрение стандартных (ERC-20, TRC-20) и кастомных токенов. Все операции осуществляются с оплатой комиссии в GND.

---

## 1. Архитектура модуля смарт-контрактов

### 1.1. Загрузка и компиляция

- Загрузка байткода смарт-контракта (полученного из Solidity-компилятора) осуществляется через специальный модуль.
- Предусмотрена предварительная компиляция и проверка корректности кода до деплоя в сеть.
- Сохраняется байткод и метаданные (версия компилятора, стандарт токена, владелец и пр.).

### 1.2. Валидация и деплой

- Проверяется корректность байткода, метаданных и цифровых подписей.
- Валидация соответствия стандарту (ERC-20, TRC-20, custom) по метаданным.
- После успешной проверки контракт регистрируется в блокчейне с уникальным адресом.
- При деплое автоматически списывается комиссия в GND.

### 1.3. Изоляция исполнения

- Для выполнения смарт-контрактов используется изолированная среда (EVM-подобная VM), адаптированная под «ГАНИМЕД».
- Перед вызовом функций контракта всегда списывается комиссия в GND.
- Контракты не могут напрямую изменять состояние вне своей области (sandbox).

---

## 2. Поддержка стандартов токенов

### 2.1. Режимы работы смарт-контрактов

- **ERC-20** - совместимость с экосистемой Ethereum, поддержка всех стандартных методов (balanceOf, transfer, approve, transferFrom и др.).
- **TRC-20** - аналогичная реализация для интеграции с другими блокчейнами.
- **Кастомные стандарты** - возможность создания собственных интерфейсов и бизнес-логики.

### 2.2. Универсальный интерфейс токенов

- Все токены реализуют единый интерфейс, позволяющий добавлять новые стандарты без изменений основного кода блокчейна.
- В метаданных контракта указывается стандарт: `"erc20"`, `"trc20"` или `"custom"`.
- Контракты могут одновременно поддерживать несколько стандартов.

#### Пример метаданных токена:

{
"standard": "erc20",
"name": "MyToken",
"symbol": "MTK",
"decimals": 18
}

text

---

## 3. Работа с контрактами через API

### 3.1. Деплой контракта

**REST:**
POST /contract/deploy
Content-Type: application/json

text
**Тело запроса:**
{
"from": "GND1...",
"bytecode": "<hex>",
"gasLimit": 2000000,
"gasPrice": 1,
"nonce": 7,
"metadata": {
"standard": "erc20",
"name": "MyToken",
"symbol": "MTK",
"decimals": 18
},
"signature": "..."
}

text
**Ответ:**
{
"contractAddress": "GNDct1..."
}

text

### 3.2. Вызов функции контракта

**REST:**
POST /contract/call
Content-Type: application/json

text
**Тело запроса:**
{
"from": "GND1...",
"to": "GNDct1...",
"data": "<hex>",
"gasLimit": 80000,
"gasPrice": 1,
"nonce": 8,
"signature": "..."
}

text
**Ответ:**
{
"result": "...",
"gasUsed": 50000
}

text

---

## 4. Примеры использования стандартов токенов

### 4.1. ERC-20

- Методы: `totalSupply`, `balanceOf`, `transfer`, `approve`, `transferFrom`, `allowance`.
- Полная совместимость с кошельками и биржами Ethereum.

### 4.2. TRC-20

- Аналогичная реализация для Tron-совместимых сервисов.
- Методы и структура идентичны ERC-20.

### 4.3. Кастомные стандарты

- Разработчик может определить собственные методы и события.
- В метаданных указывается `"standard": "custom"`, а также описание интерфейса.

---

## 5. Валидация и безопасность

- Перед деплоем обязательна проверка цифровой подписи владельца.
- Контракт проходит валидацию на соответствие стандарту.
- Все вызовы функций контрактов проходят через VM с контролем газа и sandbox-изоляцией.
- Все комиссии оплачиваются в GND.

---

## 6. Метаданные и регистрация

- При деплое контракта в блокчейн сохраняются:
    - Адрес контракта
    - Адрес владельца
    - Стандарт токена
    - Метаданные (имя, символ, decimals и др.)
    - Хеш и байткод контракта

---

## 7. Тестирование и аудит

- Для всех модулей смарт-контрактов и токенов реализуются юнит- и интеграционные тесты.
- Проводится аудит безопасности, особенно для кастомных стандартов и валидации байткода.

---

## 8. Примеры сценариев

### 8.1. Деплой ERC-20 токена

1. Скомпилируйте контракт на Solidity.
2. Отправьте байткод и метаданные через `/contract/deploy`.
3. Получите адрес токена и используйте его для операций transfer, approve и др.

### 8.2. Деплой кастомного стандарта

1. Опишите интерфейс и методы в контракте.
2. Укажите `"standard": "custom"` в метаданных.
3. После деплоя используйте методы согласно вашей бизнес-логике.

---

## 9. Расширение стандартов

- Для добавления нового стандарта реализуйте интерфейс токена в модуле tokens/.
- Зарегистрируйте стандарт в системе через метаданные.
- Контракты могут поддерживать сразу несколько стандартов (например, ERC-20 + custom).

---

## 10. Ссылки

- [api.md](api.md) - описание API для работы с контрактами и токенами
- [tokens.md](tokens.md) - описание стандартов токенов
- [architecture.md](architecture.md) - архитектура блокчейна
- [consensus.md](consensus.md) - описание алгоритмов консенсуса

---